<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0ea5e9" />
    <title>üè• Medical Deep-Research Chat System</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8fafc; }
      .container { max-width: 1200px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
      .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; text-align: center; }
      .messages { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
      .message { max-width: 70%; padding: 0.75rem 1rem; border-radius: 1rem; animation: slideIn 0.3s ease-out; }
      .message.user { background: #667eea; color: white; align-self: flex-end; margin-left: auto; }
      .message.ai { background: #e2e8f0; color: #334155; align-self: flex-start; }
      .input-area { display: flex; padding: 1rem; border-top: 1px solid #e2e8f0; gap: 0.5rem; }
      .input-area input { flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; outline: none; }
      .input-area input:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
      .input-area button { background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s; }
      .input-area button:hover { background: #5a67d8; }
      .input-area button:disabled { background: #9ca3af; cursor: not-allowed; }
      .loading { display: inline-block; width: 1rem; height: 1rem; border: 2px solid #f3f3f3; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
      @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .welcome { text-align: center; color: #64748b; margin-top: 2rem; }
      .sources { margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #d1d5db; font-size: 0.875rem; }
      .source-link { color: #667eea; text-decoration: none; margin-right: 0.5rem; }
      .source-link:hover { text-decoration: underline; }
      
      /* New styles for improved functionality */
      .input-row {
          display: flex;
          align-items: center;
          gap: 10px;
      }
      
      .file-btn {
          padding: 15px !important;
          background: #f0f0f0 !important;
          color: #666 !important;
          border: 2px solid #ddd !important;
          border-radius: 50% !important;
          width: 50px !important;
          height: 50px !important;
          font-size: 18px !important;
          cursor: pointer;
          transition: all 0.3s ease;
      }
      
      .file-btn:hover {
          background: #e0e0e0 !important;
          transform: scale(1.1);
      }
      
      /* File Upload Styles */
      .file-upload-section {
          padding: 20px;
          background: #f8f9fa;
          border-top: 1px solid #e0e0e0;
          animation: slideDown 0.3s ease;
      }
      
      .upload-area {
          border: 2px dashed #667eea;
          border-radius: 15px;
          padding: 40px;
          text-align: center;
          background: white;
          cursor: pointer;
          transition: all 0.3s ease;
      }
      
      .upload-area:hover {
          border-color: #764ba2;
          background: #f8f9ff;
      }
      
      .upload-area.dragover {
          border-color: #28a745;
          background: #f0fff4;
      }
      
      .upload-icon {
          font-size: 48px;
          margin-bottom: 15px;
      }
      
      .upload-hint {
          color: #666;
          font-size: 14px;
          margin-top: 10px;
      }
      
      .upload-progress {
          margin-top: 20px;
      }
      
      .progress-bar {
          width: 100%;
          height: 20px;
          background: #e0e0e0;
          border-radius: 10px;
          overflow: hidden;
      }
      
      .progress-fill {
          height: 100%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          width: 0%;
          transition: width 0.3s ease;
      }
      
      /* Loading Animation */
      .researching {
          display: flex;
          align-items: center;
          gap: 10px;
          color: #667eea;
          font-style: italic;
          padding: 20px;
          background: #f8f9ff;
          border-radius: 10px;
          margin: 10px 0;
      }
      
      .loading-dots::after {
          content: '';
          animation: dots 1.5s infinite;
      }
      
      @keyframes dots {
          0%, 20% { content: ''; }
          40% { content: '.'; }
          60% { content: '..'; }
          80%, 100% { content: '...'; }
      }
      
      @keyframes slideDown {
          from {
              opacity: 0;
              transform: translateY(-20px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }
      
      /* Message styling improvements */
      .message h1, .message h2, .message h3 {
          margin-top: 20px;
          margin-bottom: 10px;
          color: #333;
      }
      
      .message ul, .message ol {
          padding-left: 20px;
          margin: 10px 0;
      }
      
      .message li {
          margin: 5px 0;
      }
      
      .message blockquote {
          border-left: 4px solid #667eea;
          padding: 10px 15px;
          margin: 15px 0;
          background: #f8f9ff;
          border-radius: 5px;
      }
      
      .message hr {
          border: none;
          height: 1px;
          background: linear-gradient(90deg, transparent, #ddd, transparent);
          margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
        <div class="header">
            <h1>üè• Medical Deep-Research Chat System</h1>
            <p>AI-powered medical research assistant</p>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <!-- Messages will be dynamically added here -->
        </div>
        
        <!-- File upload section -->
        <div class="file-upload-section" id="fileUploadSection" style="display: none;">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <p>Drag & drop files here or click to browse</p>
                <p class="upload-hint">Supported: PDF, DOC, TXT, CSV</p>
                <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.csv" style="display: none;">
            </div>
            <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText">Uploading files...</p>
            </div>
        </div>
        
        <div class="input-container">
            <div class="input-row">
                <button class="file-btn" onclick="toggleFileUpload()" id="fileBtn">üìé</button>
                <input type="text" id="messageInput" placeholder="Ask about medical topics, research, treatments..." />
                <button onclick="sendMessage()" id="sendBtn">Send</button>
            </div>
        </div>
    </div>    <script>
      let isLoading = false;
      
      async function sendMessage() {
        const input = document.getElementById('messageInput');
        const button = document.getElementById('sendButton');
        const messages = document.getElementById('messages');
        
        if (!input.value.trim() || isLoading) return;
        
        const userMessage = input.value;
        input.value = '';
        isLoading = true;
        button.disabled = true;
        
        // Add user message
        addMessage(userMessage, true);
        
        // Add researching animation
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'researching';
        loadingDiv.innerHTML = 'üîç Researching medical information<span class="loading-dots"></span>';
        loadingDiv.id = 'loading-message';
        messages.appendChild(loadingDiv);
        messages.scrollTop = messages.scrollHeight;
        
        try {
          const response = await fetch('http://localhost:2000/api/chat', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
              message: userMessage,
              include_web_search: true,
              include_local_search: true
            })
          });
          
          const data = await response.json();
          
          // Remove loading message
          document.getElementById('loading-message').remove();
          
          // Add AI response
          addMessage(data.response, false, data.sources);
          
        } catch (error) {
          console.error('Error:', error);
          document.getElementById('loading-message').remove();
          addMessage('Sorry, I encountered an error. Please try again.', false);
        } finally {
          isLoading = false;
          button.disabled = false;
        }
      }
      
      function addMessage(text, isUser, sources = []) {
        const messages = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
        
        let sourcesHtml = '';
        if (sources && sources.length > 0) {
          sourcesHtml = '<div class="sources"><strong>Sources:</strong>';
          sources.forEach((source, index) => {
            sourcesHtml += `<a href="${source.url}" target="_blank" class="source-link">[${index + 1}] ${source.title}</a>`;
          });
          sourcesHtml += '</div>';
        }
        
        messageDiv.innerHTML = `<div>${text}</div>${sourcesHtml}`;
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
      }
      
      // File upload functions
      function toggleFileUpload() {
        const section = document.getElementById('fileUploadSection');
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
      }
      
      // Drag and drop functionality
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');
      
      uploadArea.addEventListener('click', () => {
        fileInput.click();
      });
      
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        handleFiles(files);
      });
      
      fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });
      
      async function handleFiles(files) {
        if (files.length === 0) return;
        
        const progressSection = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        
        progressSection.style.display = 'block';
        progressText.textContent = `Uploading ${files.length} file(s)...`;
        
        // Simulate file upload progress
        for (let i = 0; i <= 100; i += 10) {
          progressFill.style.width = i + '%';
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Process files
        try {
          const formData = new FormData();
          for (let file of files) {
            formData.append('files', file);
          }
          
          const response = await fetch('http://localhost:2000/api/upload', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          progressText.textContent = `Successfully uploaded ${files.length} file(s)!`;
          
          // Add success message
          addMessage(`üìÅ Successfully uploaded ${files.length} file(s): ${Array.from(files).map(f => f.name).join(', ')}`, false);
          
          // Hide upload section after success
          setTimeout(() => {
            document.getElementById('fileUploadSection').style.display = 'none';
            progressSection.style.display = 'none';
            progressFill.style.width = '0%';
          }, 2000);
          
        } catch (error) {
          console.error('Upload error:', error);
          progressText.textContent = 'Upload failed. Please try again.';
          addMessage('‚ùå File upload failed. Please try again.', false);
        }
      }
      
      // Enter key support
      document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
    </script>
  </body>
</html>
